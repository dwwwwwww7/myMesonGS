# ç¨€ç–æ€§æŸå¤±å®ç°éªŒè¯

## å…¬å¼

### åŸå§‹å…¬å¼

```
L_S = (1/n_ch) * Î£(i=1 to n_ch) Î£(j=1 to n_ac) |x_ij|
```

å…¶ä¸­ï¼š
- `n_ch`: é€šé“æ•°ï¼ˆé«˜æ–¯å±æ€§æ•°é‡ï¼‰= 55
- `n_ac`: ACç³»æ•°æ•°é‡ = ç‚¹æ•° - 1
- `x_ij`: ç¬¬iä¸ªé€šé“çš„ç¬¬jä¸ªACç³»æ•°

### å«ä¹‰

**æ¯ä¸ªé€šé“çš„å¹³å‡L1èŒƒæ•°**

## å®ç°éªŒè¯

### å½“å‰å®ç°

```python
# mesongs.py
raht_ac = render_pkg["raht_coeffs"]  # shape: [n_ac, n_ch]
n_ch = raht_ac.shape[1]  # 55
loss_S = torch.abs(raht_ac).sum() / n_ch
```

### æ•°å­¦ç­‰ä»·æ€§

```
torch.abs(raht_ac).sum() / n_ch

= (Î£_j Î£_i |x_ij|) / n_ch

= (1/n_ch) * Î£_j Î£_i |x_ij|

= (1/n_ch) * Î£_i Î£_j |x_ij|  (æ±‚å’Œé¡ºåºå¯äº¤æ¢)

= å…¬å¼ä¸­çš„ L_S  âœ“
```

### é€æ­¥éªŒè¯

**æ­¥éª¤1**: è®¡ç®—æ‰€æœ‰ç³»æ•°çš„ç»å¯¹å€¼
```python
abs_coeffs = torch.abs(raht_ac)  # shape: [n_ac, n_ch]
```

**æ­¥éª¤2**: æ±‚å’Œ
```python
total_sum = abs_coeffs.sum()  # æ ‡é‡
# = Î£_j Î£_i |x_ij|
# = |x_00| + |x_01| + ... + |x_0,n_ch-1| +
#   |x_10| + |x_11| + ... + |x_1,n_ch-1| +
#   ...
#   |x_n_ac-1,0| + ... + |x_n_ac-1,n_ch-1|
```

**æ­¥éª¤3**: é™¤ä»¥é€šé“æ•°
```python
loss_S = total_sum / n_ch
# = (1/n_ch) * Î£_j Î£_i |x_ij|
```

### ç¤ºä¾‹è®¡ç®—

å‡è®¾ï¼š
- n_ac = 3ï¼ˆ3ä¸ªACç³»æ•°ï¼‰
- n_ch = 2ï¼ˆ2ä¸ªé€šé“ï¼‰

```
raht_ac = [
    [1.0, -2.0],  # ACç³»æ•°0
    [3.0,  4.0],  # ACç³»æ•°1
    [-5.0, 6.0]   # ACç³»æ•°2
]

æ­¥éª¤1: å–ç»å¯¹å€¼
abs_coeffs = [
    [1.0, 2.0],
    [3.0, 4.0],
    [5.0, 6.0]
]

æ­¥éª¤2: æ±‚å’Œ
total_sum = 1.0 + 2.0 + 3.0 + 4.0 + 5.0 + 6.0 = 21.0

æ­¥éª¤3: é™¤ä»¥é€šé“æ•°
loss_S = 21.0 / 2 = 10.5

éªŒè¯:
é€šé“0çš„L1èŒƒæ•°: |1.0| + |3.0| + |-5.0| = 9.0
é€šé“1çš„L1èŒƒæ•°: |-2.0| + |4.0| + |6.0| = 12.0
å¹³å‡L1èŒƒæ•°: (9.0 + 12.0) / 2 = 10.5 âœ“
```

## ä»£ç å®ç°æ£€æŸ¥

### mesongs.py ä¸­çš„å®ç°

```python
# ç¨€ç–æ€§æŸå¤± (Sparsity loss)
loss_S = 0.0
if dataset.lambda_sparsity > 0 and "raht_coeffs" in render_pkg:
    # è·å–RAHT ACç³»æ•°
    raht_ac = render_pkg["raht_coeffs"]  # shape: [n_ac, n_ch]
    
    # è®¡ç®—ç¨€ç–æ€§æŸå¤±: L_S = (1/n_ch) * Î£_i Î£_j |x_ij|
    n_ch = raht_ac.shape[1]  # é€šé“æ•° (55)
    n_ac = raht_ac.shape[0]   # ACç³»æ•°æ•°é‡
    
    # å®ç°: (1/n_ch) * sum(|x_ij|) for all i,j
    loss_S = torch.abs(raht_ac).sum() / n_ch
```

**æ£€æŸ¥æ¸…å•**:
- âœ… raht_ac å½¢çŠ¶æ­£ç¡®: [n_ac, n_ch]
- âœ… ä½¿ç”¨ torch.abs() è®¡ç®—ç»å¯¹å€¼
- âœ… ä½¿ç”¨ .sum() å¯¹æ‰€æœ‰å…ƒç´ æ±‚å’Œ
- âœ… é™¤ä»¥ n_chï¼ˆé€šé“æ•°ï¼‰
- âœ… å…¬å¼å®ç°æ­£ç¡®

### gaussian_renderer/__init__.py ä¸­çš„è¿”å›

```python
# å¦‚æœä½¿ç”¨RAHTä¸”åœ¨è®­ç»ƒæ¨¡å¼ï¼Œè¿”å›ACç³»æ•°ç”¨äºç¨€ç–æ€§æŸå¤±
if raht and training and 'C' in locals():
    result["raht_coeffs"] = C[1:]  # åªè¿”å›ACç³»æ•°ï¼Œä¸åŒ…æ‹¬DC
```

**æ£€æŸ¥æ¸…å•**:
- âœ… åªåœ¨è®­ç»ƒæ—¶è¿”å›ï¼ˆtraining=Trueï¼‰
- âœ… åªåœ¨ä½¿ç”¨RAHTæ—¶è¿”å›ï¼ˆraht=Trueï¼‰
- âœ… è¿”å›ACç³»æ•°ï¼ˆC[1:]ï¼Œè·³è¿‡DCç³»æ•°C[0]ï¼‰
- âœ… å½¢çŠ¶æ­£ç¡®: [n_ac, n_ch] = [ç‚¹æ•°-1, 55]

## æ€»æŸå¤±å‡½æ•°

### å®ç°

```python
# æ•°æ®ä¿çœŸæŸå¤±
loss_D = (1.0 - opt.lambda_dssim) * Ll1 + opt.lambda_dssim * (1.0 - ssim(image, gt_image))

# ç¨€ç–æ€§æŸå¤±
loss_S = torch.abs(raht_ac).sum() / n_ch

# æ€»æŸå¤±
loss = (1.0 - dataset.lambda_sparsity) * loss_D + dataset.lambda_sparsity * loss_S
```

### éªŒè¯

**å…¬å¼**: L = (1 - Î»_s) * L_D + Î»_s * L_S

**ç¤ºä¾‹**ï¼ˆÎ»_s = 5e-7ï¼‰:
```
L_D = 0.023456
L_S = 1234.567
Î»_s = 5e-7

L = (1 - 5e-7) * 0.023456 + 5e-7 * 1234.567
  = 0.9999995 * 0.023456 + 0.0000005 * 1234.567
  = 0.0234559 + 0.0006173
  = 0.0240732
```

**æ£€æŸ¥**:
- âœ… L_D æƒé‡: (1 - Î»_s) â‰ˆ 1.0ï¼ˆä¸»å¯¼ï¼‰
- âœ… L_S æƒé‡: Î»_s = 5e-7ï¼ˆå¾ˆå°ï¼‰
- âœ… æ€»æŸå¤±ä¸»è¦ç”±L_Då†³å®šï¼ŒL_Sèµ·æ­£åˆ™åŒ–ä½œç”¨

## æ•°å€¼èŒƒå›´åˆ†æ

### å…¸å‹å€¼ï¼ˆtruckåœºæ™¯ï¼‰

```
n_ac = 343,375  (ç‚¹æ•° - 1)
n_ch = 55       (é€šé“æ•°)

RAHTç³»æ•°èŒƒå›´: [-50, 50]
å¹³å‡ç»å¯¹å€¼: ~5.0

L_S ä¼°ç®—:
  = (1/55) * (343,375 Ã— 55 Ã— 5.0)
  = (1/55) * 94,428,125
  â‰ˆ 1,716,875

L_D å…¸å‹å€¼: ~0.02

Î»_s * L_S:
  = 5e-7 * 1,716,875
  â‰ˆ 0.858

L_D å’Œ Î»_s * L_S çš„æ¯”ä¾‹:
  0.02 : 0.858 â‰ˆ 1 : 43
```

**è§‚å¯Ÿ**:
- L_S çš„æ•°å€¼å¾ˆå¤§ï¼ˆç™¾ä¸‡çº§ï¼‰
- ä½† Î»_s å¾ˆå°ï¼ˆ1e-7çº§ï¼‰
- ä¸¤è€…ç›¸ä¹˜åä¸ L_D åŒé‡çº§
- è¿™æ˜¯åˆç†çš„æƒé‡è®¾ç½®

## æ¢¯åº¦åˆ†æ

### ç¨€ç–æ€§æŸå¤±çš„æ¢¯åº¦

```
âˆ‚L_S/âˆ‚x_ij = (1/n_ch) * sign(x_ij)
```

**æ•ˆæœ**:
- æ­£ç³»æ•°: æ¢¯åº¦ä¸ºæ­£ â†’ æ¨åŠ¨å‡å°
- è´Ÿç³»æ•°: æ¢¯åº¦ä¸ºè´Ÿ â†’ æ¨åŠ¨å¢å¤§ï¼ˆç»å¯¹å€¼å‡å°ï¼‰
- é›¶ç³»æ•°: æ¢¯åº¦ä¸ºé›¶ â†’ ä¿æŒä¸ºé›¶

### æ€»æ¢¯åº¦

```
âˆ‚L/âˆ‚x_ij = (1 - Î»_s) * âˆ‚L_D/âˆ‚x_ij + Î»_s * âˆ‚L_S/âˆ‚x_ij
         = (1 - Î»_s) * âˆ‚L_D/âˆ‚x_ij + Î»_s * (1/n_ch) * sign(x_ij)
```

**æ•ˆæœ**:
- ä¸»è¦ç”±æ•°æ®ä¿çœŸæŸå¤±é©±åŠ¨ï¼ˆæƒé‡ â‰ˆ 1ï¼‰
- ç¨€ç–æ€§æŸå¤±æä¾›è½»å¾®çš„æ­£åˆ™åŒ–ï¼ˆæƒé‡ â‰ˆ 5e-7ï¼‰
- æ¨åŠ¨å°ç³»æ•°è¶‹å‘é›¶

## å®ç°æ­£ç¡®æ€§æ€»ç»“

### âœ… å…¬å¼å®ç°æ­£ç¡®

```python
# å…¬å¼
L_S = (1/n_ch) * Î£_i Î£_j |x_ij|

# å®ç°
loss_S = torch.abs(raht_ac).sum() / n_ch

# ç­‰ä»·æ€§
torch.abs(raht_ac).sum() = Î£_i Î£_j |x_ij|  âœ“
é™¤ä»¥ n_ch                = (1/n_ch) * ...   âœ“
```

### âœ… æ•°æ®æµæ­£ç¡®

```
ft_render() â†’ è¿”å› raht_coeffs (ACç³»æ•°)
    â†“
mesongs.py â†’ è®¡ç®— loss_S
    â†“
loss = (1-Î»_s)*L_D + Î»_s*L_S
    â†“
loss.backward() â†’ æ›´æ–°å‚æ•°
```

### âœ… å‚æ•°é…ç½®æ­£ç¡®

```python
# arguments/__init__.py
self.lambda_sparsity = 5e-7  # é»˜è®¤å€¼

# å¯ä»¥ä¿®æ”¹ä¸ºå…¶ä»–å€¼
```

### âœ… æ—¥å¿—è¾“å‡ºæ­£ç¡®

```
å¾®è°ƒè¿›åº¦: æŸå¤±=0.023, L1=0.012, ç¨€ç–=1.23e+03
```

## ç»“è®º

**å®ç°å®Œå…¨æ­£ç¡®ï¼** âœ“

- âœ… å…¬å¼å®ç°å‡†ç¡®
- âœ… æ•°æ®æµæ­£ç¡®
- âœ… å‚æ•°å¯é…ç½®
- âœ… æ—¥å¿—å®Œæ•´
- âœ… æ¢¯åº¦æ­£ç¡®ä¼ æ’­

å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ï¼ğŸ¯
